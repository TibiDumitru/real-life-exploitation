import os
from dotenv import load_dotenv
from flask import Flask, request, jsonify
from pymongo import MongoClient
import logging

load_dotenv()

app = Flask(__name__)

# Connect to MongoDB Atlas
MONGO_USER = os.getenv("MONGO_USER")
MONGO_PASSWORD = os.getenv("MONGO_PASSWORD")
MONGO_DBNAME = os.getenv("MONGO_DBNAME")
MONGO_CONNECTION_STRING = f"mongodb+srv://{MONGO_USER}:{MONGO_PASSWORD}@{MONGO_DBNAME}"
client = MongoClient(MONGO_CONNECTION_STRING)
db = client["movies"]
movies = db["movies"]

# Logging
logging.basicConfig(filename='app.log', filemode='w', format='%(name)s - %(levelname)s - %(message)s')

@app.route("/movie", methods=["PUT"])
def add_movie():
    try:
        movie_data = request.get_json()
        if 'name' not in movie_data or 'year' not in movie_data:
            raise ValueError("The json need to have 'name' and 'year' keys")
        # Insert movie data into MongoDB
        movies.insert_one(movie_data)
        return jsonify({"message": "Movie added successfully"})
    except Exception as e:
        logging.error(e)
        return jsonify({"error": str(e)}), 400

@app.route("/movie/<movie_id>", methods=["GET"])
def get_movie(movie_id):
    try:
        movie = movies.find_one({"_id": movie_id})
        if movie is None:
            raise ValueError(f"Movie with id {movie_id} not found")
        # Return movie data as JSON
        return jsonify(movie)
    except Exception as e:
        logging.error(e)
        return jsonify({"error": str(e)}), 404

if __name__ == '__main__':
    app.run(debug=True)
